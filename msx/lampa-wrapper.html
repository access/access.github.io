<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Lampa Wrapper</title>
  <style>
    html, body { width:100%; height:100%; margin:0; padding:0; background:#000; overflow:hidden; }
    /* НЕ трогаем глобальные шрифты/размеры — иначе ломает UI Lampa */

    /* Лампа рендерит сама в body — контейнер чисто для фона/заглушки */
    #boot {
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:#000;
      z-index:0;
    }
    #boot img { width:96px; height:96px; opacity:.9; }

    /* Логи — маленький оверлей, не перехватывает управление */
    #log {
      position:fixed; left:10px; right:10px; bottom:10px;
      max-height:32vh;
      overflow:auto;
      padding:8px 10px;
      font: 12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color:#cfcfcf;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px;
      z-index:999999;
      pointer-events:none;
      white-space:pre-wrap;
      word-break:break-word;
    }
    #log .ok { color:#7CFC00; }
    #log .err { color:#ff6b6b; }
    #log .dim { opacity:.8; }
  </style>
</head>
<body>
  <div id="boot" aria-hidden="true">
    <img src="https://yumata.github.io/lampa/img/logo_icon.png" alt="" />
  </div>
  <div id="log" aria-live="polite"></div>

  <script>
    (function(){
      'use strict';

      const LOG = document.getElementById('log');
      const boot = document.getElementById('boot');

      function log(line, cls){
        const el = document.createElement('div');
        if (cls) el.className = cls;
        el.textContent = line;
        LOG.appendChild(el);
        // автоскролл
        LOG.scrollTop = LOG.scrollHeight;
      }

      function absBase(){
        // https://access.github.io/msx/lampa-wrapper.html -> https://access.github.io/msx/
        return new URL('.', location.href).href;
      }

      // ВАЖНО: на части ТВ события приходят только в фокусируемый элемент
      function ensureFocus(){
        try {
          if (!document.body.hasAttribute('tabindex')) document.body.tabIndex = 0;
          document.body.focus({ preventScroll:true });
        } catch (_) {}
      }
      document.addEventListener('visibilitychange', ensureFocus);
      window.addEventListener('focus', ensureFocus);

      // Настройки Лампы до загрузки app.min.js
      // (можешь тут добавить любые свои флаги/disable_features и т.п.)
      window.lampa_settings = window.lampa_settings || {};
      window.lampa_settings.disable_features = window.lampa_settings.disable_features || {};

      // Наш URL блеклиста (лежит рядом с wrapper)
      const BLACKLIST_URL = absBase() + 'plugins_black_list.json';

      // Загрузка скрипта
      function loadScript(src, name){
        return new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.async = true;
          s.src = src;
          s.onload = () => { log('[OK] loaded: ' + (name || src), 'ok'); resolve(); };
          s.onerror = (e) => { log('[ERR] failed: ' + src, 'err'); reject(new Error('Failed to load ' + src)); };
          document.head.appendChild(s);
        });
      }

      async function main(){
        log('[LOG] UA: ' + navigator.userAgent, 'dim');

        // vendor берём из yumata (там оно реально есть)
        await loadScript('https://yumata.github.io/lampa/vendor/jquery/jquery.js', 'jquery');
        await loadScript('https://yumata.github.io/lampa/vendor/navigator/navigator.js', 'navigator');
        await loadScript('https://yumata.github.io/lampa/vendor/keypad/keypad.js', 'keypad');

        // Включаем режим ТВ раньше, чтобы правильная ветка init (контроллер/навигация)
        try {
          if (window.Lampa && window.Lampa.Platform && typeof window.Lampa.Platform.tv === 'function') {
            window.Lampa.Platform.tv();
            log('[OK] Lampa.Platform.tv() called', 'ok');
          }
        } catch (e) {
          log('[ERR] Lampa.Platform.tv() failed: ' + (e && e.message ? e.message : String(e)), 'err');
        }

        // Забираем app.min.js и ПАТЧИМ только пути (без ломания логики)
        const appUrl = 'https://raw.githubusercontent.com/yumata/lampa/main/app.min.js';
        log('[LOG] fetch app.min.js: ' + appUrl, 'dim');
        const res = await fetch(appUrl, { cache: 'no-store' });
        if (!res.ok) throw new Error('app.min.js status: ' + res.status);
        let code = await res.text();

        // 1) vendor/lib'ы всегда грузим с yumata.github.io/lampa/ (иначе ./vender/* ищется на access.github.io)
        code = code.replace(
          /window\.location\.protocol == 'file:' \|\| window\.location\.href\.indexOf\('chrome-extension'\) > -1 \? object\$2\.github_lampa \+ 'vender\/' \+ lib : '\.\/vender\/' \+ lib;/g,
          "window.location.protocol == 'file:' || window.location.href.indexOf('chrome-extension') > -1 ? object$2.github_lampa + 'vender/' + lib : object$2.github_lampa + 'vender/' + lib;"
        );

        // 2) языки тоже с yumata (иначе ./lang/* ищется на access.github.io)
        code = code.replace(
          /(location\.protocol == 'file:' \|\| Platform\.desktop\(\) \? object\$2\.github_lampa : '\.\/'\) \+ 'lang\//g,
          "object$2.github_lampa + 'lang/"
        );

        // 3) блеклист — НАШ (рядом с wrapper)
        code = code.replace(/'\.\/plugins_black_list\.json'/g, JSON.stringify(BLACKLIST_URL));

        // (опционально) если не хочешь зависеть от personal.lampa (у тебя его нет) — глушим запрос
        // Это не обязано падать, но чтобы не спамило 404:
        code = code.replace(/'personal\.lampa'/g, JSON.stringify(absBase() + 'personal.lampa'));

        log('[LOG] run app.min.js (blob)...', 'dim');
        const blob = new Blob([code], { type: 'text/javascript' });
        const blobUrl = URL.createObjectURL(blob);
        await loadScript(blobUrl, 'app.min.js (patched)');

        // Когда Лампа ожила — убираем boot-лого и принудительно фокус
        const t0 = Date.now();
        const timer = setInterval(() => {
          const ok = !!(window.Lampa && window.Lampa.Listener);
          if (ok || Date.now() - t0 > 8000) {
            clearInterval(timer);
            boot.style.display = 'none';
            ensureFocus();
            log('[OK] Lampa started', 'ok');
          }
        }, 100);
      }

      main().catch((e) => {
        log('[ERR] ' + (e && e.stack ? e.stack : String(e)), 'err');
      });

      // стартовый фокус
      ensureFocus();
    })();
  </script>
</body>
</html>
