<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Lampa Wrapper</title>
  <style>
    html, body { height: 100%; width: 100%; margin: 0; background: #000; overflow: hidden; }
    /* Lampa renders into body; ensure full-screen base */
    body { position: relative; }

    /* Debug log overlay (hidden by default) */
    #wraplog {
      position: absolute; inset: 0;
      font: 12px/1.35 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: #d7d7d7;
      background: rgba(0,0,0,0.55);
      padding: 10px 12px;
      white-space: pre-wrap;
      word-break: break-word;
      overflow: auto;
      z-index: 999999;
      display: none;          /* toggle with key 0 */
      pointer-events: auto;   /* only when shown */
    }
    #wraplog.visible { display: block; }

    /* When log is hidden, it must not steal focus/clicks */
    #wraplog:not(.visible) { pointer-events: none; }

    /* Small hint */
    #hint {
      position: absolute; right: 10px; top: 10px;
      font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: rgba(255,255,255,0.55);
      z-index: 999998;
      user-select: none;
      pointer-events: none;
    }
  </style>
</head>
<body tabindex="0">
  <div id="hint">0: log</div>
  <pre id="wraplog"></pre>

<script>
(() => {
  'use strict';

  // --- CONFIG
  const UPSTREAM = 'https://yumata.github.io/lampa/';
  const APP_MIN  = 'https://raw.githubusercontent.com/yumata/lampa/main/app.min.js';

  // If you host these next to the wrapper, keep as-is.
  const LOCAL_BLACKLIST = './plugins_black_list.json';
  const LOCAL_PERSONAL  = './personal.lampa';

  const logEl = document.getElementById('wraplog');
  const hintEl = document.getElementById('hint');
  const log = (...a) => {
    try {
      const s = a.map(x => (typeof x === 'string' ? x : JSON.stringify(x))).join(' ');
      logEl.textContent += s + '\n';
      // keep tail visible
      logEl.scrollTop = logEl.scrollHeight;
    } catch (_) {}
    // also mirror to console
    console.log(...a);
  };

  // Toggle log with key "0" (works on many TV remotes too)
  window.addEventListener('keydown', (e) => {
    const k = e.key || '';
    if (k === '0' || e.keyCode === 48) {
      logEl.classList.toggle('visible');
      hintEl.style.display = logEl.classList.contains('visible') ? 'none' : 'block';
    }
  }, true);

  // Keep focus on body so key events reach Lampa on TVs that require focus.
  const refocus = () => {
    try { document.body.focus({preventScroll:true}); } catch (_) { try { document.body.focus(); } catch (_) {} }
  };
  window.addEventListener('load', refocus);
  window.addEventListener('blur', () => setTimeout(refocus, 50));
  document.addEventListener('click', refocus);

  // --- HARDEN: history.pushState cross-origin rewrite
  // Some builds push absolute URLs (UPSTREAM origin). That breaks when wrapper is hosted elsewhere.
  // We rewrite any absolute URL to current origin, preserving path+query+hash.
  const rewriteToSameOrigin = (url) => {
    try {
      if (!url) return url;
      const u = new URL(url, location.href);
      if (u.origin !== location.origin) {
        // keep full path/search/hash, but force same origin
        return location.origin + u.pathname + u.search + u.hash;
      }
      return u.href;
    } catch (_) {
      return url;
    }
  };
  const _push = history.pushState.bind(history);
  const _repl = history.replaceState.bind(history);
  history.pushState = function(state, title, url) { return _push(state, title, rewriteToSameOrigin(url)); };
  history.replaceState = function(state, title, url) { return _repl(state, title, rewriteToSameOrigin(url)); };

  // --- Load required vendors (as upstream static files)
  const loadScript = (src) => new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = src;
    s.async = false;
    s.onload = () => resolve();
    s.onerror = (e) => reject(new Error('Failed to load: ' + src));
    document.head.appendChild(s);
  });

  // Ensure upstream-relative dynamic loads ("./vender/..." etc) resolve to UPSTREAM.
  // app.min.js uses relative URLs in multiple places.
  const base = document.createElement('base');
  base.href = UPSTREAM;
  document.head.insertBefore(base, document.head.firstChild);

  const boot = async () => {
    log('[LOG] UA:', navigator.userAgent);

    await loadScript(UPSTREAM + 'vender/jquery/jquery.js');
    log('[OK] loaded: jquery');

    await loadScript(UPSTREAM + 'vender/navigator/navigator.js');
    log('[OK] loaded: navigator');

    await loadScript(UPSTREAM + 'vender/keypad/keypad.js');
    log('[OK] loaded: keypad');

    // Let Lampa detect TV mode
    window.Lampa = window.Lampa || {};
    // Many builds call Lampa.Platform.tv(); if platform module is inside app.min.js, ok.

    // Fetch + patch app.min.js
    log('[LOG] fetch app.min.js:', APP_MIN);
    const r = await fetch(APP_MIN, { cache: 'no-store' });
    if (!r.ok) throw new Error('app.min.js status: ' + r.status);
    let code = await r.text();

    // Patch known URLs so wrapper-origin hosting works.
    // 1) Blacklist URL
    code = code.replaceAll('https://yumata.github.io/lampa/plugins_black_list.json', LOCAL_BLACKLIST);
    code = code.replaceAll('plugins_black_list.json', LOCAL_BLACKLIST.replace(/^\.\//, ''));
    // 2) personal.lampa (optional)
    code = code.replaceAll('https://yumata.github.io/lampa/personal.lampa', LOCAL_PERSONAL);
    code = code.replaceAll('personal.lampa', LOCAL_PERSONAL.replace(/^\.\//, ''));
    // 3) hardcode upstream base if present as literal
    // (do NOT force-replace; just align some common patterns)
    code = code.replaceAll('https://yumata.github.io/lampa//', 'https://yumata.github.io/lampa/');

    // Execute as a blob script to keep wrapper page clean.
    const blob = new Blob([code], { type: 'text/javascript' });
    const url = URL.createObjectURL(blob);

    log('[LOG] run app.min.js (blob)...');
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = url;
      s.async = false;
      s.onload = () => resolve();
      s.onerror = () => reject(new Error('Failed to execute app.min.js'));
      document.body.appendChild(s);
    });

    // Cleanup
    setTimeout(() => URL.revokeObjectURL(url), 30_000);

    // Final focus kick
    setTimeout(refocus, 100);
    log('[OK] Lampa started');
  };

  boot().catch((e) => {
    console.error(e);
    log('[ERR]', e && e.message ? e.message : String(e));
    logEl.classList.add('visible');
    hintEl.style.display = 'none';
  });
})();
</script>
</body>
</html>
