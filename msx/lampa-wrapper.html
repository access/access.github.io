<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Lampa Wrapper</title>

  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: #000;
      overflow: hidden;
    }

    /* Лог поверх, но НЕ трогаем пульт/клики */
    #bootlog {
      position: fixed;
      left: 0; top: 0; right: 0;
      max-height: 55vh;
      overflow: hidden;
      font: 18px/1.25 monospace;
      color: #e8e8e8;
      background: rgba(0,0,0,0.55);
      padding: 10px 12px;
      white-space: pre-wrap;
      z-index: 2147483647;
      pointer-events: none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.9);
    }
    #bootlog .dim { color: #b8b8b8; }
    #bootlog .ok  { color: #b7ffb7; }
    #bootlog .err { color: #ffb7b7; }
  </style>

  <!-- Важно: Lampa должна думать, что база = yumata.github.io/lampa/ -->
  <base href="https://yumata.github.io/lampa/">
</head>

<body tabindex="0">
  <div id="bootlog"></div>

  <script>
    (function () {
      'use strict';

      const BASE = 'https://yumata.github.io/lampa/';
      const UPSTREAM_APP_MIN = 'https://raw.githubusercontent.com/yumata/lampa/main/app.min.js';

      const logEl = document.getElementById('bootlog');
      const t0 = Date.now();

      function ts() {
        const ms = Date.now() - t0;
        return (ms / 1000).toFixed(3).padStart(7, ' ');
      }

      function add(kind, msg) {
        const cls = kind === 'ERR' ? 'err' : (kind === 'OK' ? 'ok' : 'dim');
        logEl.textContent += `${ts()} [${kind}] ${msg}\n`;
        // ограничим чтобы не раздувалось
        const lines = logEl.textContent.split('\n');
        if (lines.length > 250) logEl.textContent = lines.slice(-250).join('\n');
      }

      window.addEventListener('error', (e) => {
        add('ERR', `window.onerror: ${e.message || e.error}`);
      });

      window.addEventListener('unhandledrejection', (e) => {
        add('ERR', `unhandledrejection: ${String(e.reason)}`);
      });

      // Фокус (иначе MSX/WebView может не отдавать keydown)
      function keepFocus() {
        try { document.body.focus(); } catch (_) {}
        setTimeout(keepFocus, 1500);
      }
      keepFocus();

      // Просто чтобы видеть, идут ли вообще кнопки с пульта
      window.addEventListener('keydown', (e) => {
        add('LOG', `key: code=${e.code} key=${e.key} keyCode=${e.keyCode}`);
      }, true);

      function loadScript(url) {
        return new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = url;
          s.async = false;
          s.onload = () => resolve();
          s.onerror = () => reject(new Error('Failed: ' + url));
          document.head.appendChild(s);
        });
      }

      async function boot() {
        add('LOG', `UA: ${navigator.userAgent}`);

        // Вендоры (они дают Navigator/Keypad/ObjectCollection и т.п.)
        // Порядок важен.
        const vendors = [
          BASE + 'vender/jquery/jquery.js',
          BASE + 'vender/dash/dash.js',
          BASE + 'vender/hls/hls.js',
          BASE + 'vender/keypad/keypad.js',
          BASE + 'vender/notify/notify.js',
          BASE + 'vender/vast/vast.js',
          BASE + 'vender/scrollbar/jquery.scrollbar.js',
          BASE + 'vender/qrencode/qrencode.js',
          BASE + 'vender/navigator/navigator.js',
          BASE + 'vender/keypad/keypad.js'
        ];

        for (const u of vendors) {
          add('LOG', `load vendor: ${u}`);
          await loadScript(u);
          add('OK',  `loaded: ${u.split('/').slice(-2).join('/')}`);
        }

        // app.min.js — грузим текстом, чтобы можно было патчить, и запускаем через blob
        add('LOG', `fetch app.min.js: ${UPSTREAM_APP_MIN}`);
        const res = await fetch(UPSTREAM_APP_MIN, { cache: 'no-store' });
        add('LOG', `app.min.js status: ${res.status} ${res.statusText}`);
        if (!res.ok) throw new Error('app.min.js fetch failed: ' + res.status);

        let js = await res.text();
        add('OK', `app.min.js bytes: ${js.length}`);

        // (Опционально) твои патчи сюда.
        // ВАЖНО: НЕ подменяем Navigator.* — он теперь реальный из vender/navigator/navigator.js
        // Пример: вырубить blacklist если ты это делал раньше:
        // js = js.replace(/black_list\\s*=\\s*\\[[^\\]]*\\]/, 'black_list=[]');

        const blob = new Blob([js], { type: 'text/javascript' });
        const blobUrl = URL.createObjectURL(blob);

        add('LOG', 'run app.min.js (blob)…');
        await loadScript(blobUrl);
        add('OK', 'app.min.js executed');

        // Если нужно явно перевести в TV-режим раньше/жёстче:
        // (обычно Lampa сама это делает, но на некоторых TV полезно)
        setTimeout(() => {
          try {
            if (window.Lampa && window.Lampa.Platform && window.Lampa.Platform.tv) {
              window.Lampa.Platform.tv();
              add('OK', 'Lampa.Platform.tv() called');
            } else {
              add('LOG', 'Lampa.Platform.tv() not found yet');
            }
          } catch (e) {
            add('ERR', 'Lampa.Platform.tv() error: ' + e.message);
          }
        }, 200);

        // Контроль: появился ли Lampa / инициализация навигации
        let waited = 0;
        const iv = setInterval(() => {
          waited += 250;
          const hasL = !!window.Lampa;
          const hasNav = typeof window.Navigator === 'object' && window.Navigator;
          add('LOG', `alive: Lampa=${hasL} Navigator=${!!hasNav}`);
          if (hasL || waited > 15000) clearInterval(iv);
        }, 250);
      }

      boot().catch((e) => {
        add('ERR', e && e.stack ? e.stack : String(e));
      });
    })();
  </script>
</body>
</html>
