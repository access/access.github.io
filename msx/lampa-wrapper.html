<!doctype html>
<html>
<head>
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1, viewport-fit=cover' />
  <title>Lampa wrapper</title>

  <!-- IMPORTANT:
       НЕ ставим <base href="https://yumata.github.io/...">.
       Иначе history.pushState('?x=') резолвится в чужой origin и падает SecurityError.
  -->

  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; background:#000; overflow:hidden; }

    /* Lampa контейнер (контент) */
    #lampa_root { position:fixed; inset:0; z-index:1; }

    /* Логи поверх, но НЕ мешают управлению */
    #log_overlay {
      position:fixed; left:0; top:0; right:0; bottom:0;
      z-index:99999;
      pointer-events:none;
      font:12px/1.25 monospace;
      color:#fff;
      opacity:0.65;
      white-space:pre-wrap;
      word-break:break-word;
      padding:10px 12px;
      background:transparent;
    }
    #log_overlay.hidden { display:none; }

    #log_controls {
      position:fixed;
      top:10px; left:10px;
      z-index:100000;
      pointer-events:auto;
      display:flex; gap:8px;
    }
    #log_controls button {
      font:12px/1.2 sans-serif;
      padding:6px 10px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.55);
      color:#fff;
      cursor:pointer;
    }

    #status_line {
      position:fixed;
      top:10px; right:10px;
      z-index:100000;
      pointer-events:none;
      font:12px/1.2 monospace;
      color:#fff;
      background:rgba(0,0,0,0.35);
      border:1px solid rgba(255,255,255,0.15);
      border-radius:8px;
      padding:6px 10px;
      max-width:60vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
  </style>

  <!-- Подключаем CSS как в оригинальном index.html, но абсолютными URL -->
  <link rel='stylesheet' href='https://yumata.github.io/lampa/css/fontawesome.css' />
  <link rel='stylesheet' href='https://yumata.github.io/lampa/css/solid.css' />
  <link rel='stylesheet' href='https://yumata.github.io/lampa/css/regular.css' />
  <link rel='stylesheet' href='https://yumata.github.io/lampa/css/brands.css' />
  <link rel='stylesheet' href='https://yumata.github.io/lampa/css/style.css' />
</head>
<body>
  <div id='lampa_root'></div>

  <div id='log_controls'>
    <button id='btn_toggle'>Hide log</button>
    <button id='btn_clear'>Clear</button>
  </div>
  <div id='status_line'>boot…</div>
  <div id='log_overlay'></div>

<script>
(() => {
  const $log = document.getElementById('log_overlay');
  const $status = document.getElementById('status_line');
  const $toggle = document.getElementById('btn_toggle');
  const $clear = document.getElementById('btn_clear');

  let logHidden = false;
  let buf = [];
  const MAX = 300;

  function line(s){
    buf.push(String(s));
    if (buf.length > MAX) buf.splice(0, buf.length - MAX);
    if (!logHidden) $log.textContent = buf.join('\n');
  }
  function status(s){ $status.textContent = String(s); }

  $toggle.onclick = () => {
    logHidden = !logHidden;
    $log.classList.toggle('hidden', logHidden);
    $toggle.textContent = logHidden ? 'Show log' : 'Hide log';
    if (!logHidden) $log.textContent = buf.join('\n');
  };
  $clear.onclick = () => { buf = []; $log.textContent = ''; };

  // нормальный фокус для ТВ/пульта
  window.addEventListener('load', () => {
    try { window.focus(); } catch(e) {}
    try { document.body.focus && document.body.focus(); } catch(e) {}
  });

  // логируем console
  const orig = {
    log: console.log.bind(console),
    warn: console.warn.bind(console),
    error: console.error.bind(console),
  };
  console.log = (...a) => { orig.log(...a); line('[LOG] ' + a.map(String).join(' ')); };
  console.warn = (...a) => { orig.warn(...a); line('[WRN] ' + a.map(String).join(' ')); };
  console.error = (...a) => { orig.error(...a); line('[ERR] ' + a.map(String).join(' ')); };

  window.addEventListener('error', (e) => {
    line('[ERR] window.onerror: ' + (e && e.message ? e.message : e));
  });
  window.addEventListener('unhandledrejection', (e) => {
    line('[ERR] unhandledrejection: ' + (e && e.reason ? e.reason : e));
  });

  // Подмена корня, чтобы Лампа рисовала в наш контейнер (если ей важно)
  // В оригинале она использует body; это просто страховка.
  window.__LAMPA_WRAPPER_ROOT__ = document.getElementById('lampa_root');

  function addScript(src){
    return new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = src;
      s.async = false;
      s.onload = resolve;
      s.onerror = () => reject(new Error('Failed to load: ' + src));
      document.head.appendChild(s);
    });
  }

  async function boot(){
    status('load vendors…');
    line('UA: ' + navigator.userAgent);

    // Вендоры как в index.html (ВАЖНО: порядок)
    await addScript('https://yumata.github.io/lampa/vender/jquery/jquery.js');
    await addScript('https://yumata.github.io/lampa/vender/navigator/navigator.js');
    await addScript('https://yumata.github.io/lampa/vender/keypad/keypad.js');
    await addScript('https://yumata.github.io/lampa/vender/controller/controller.js');

    // Гарантируем tv-режим и фокус (после vendor'ов)
    status('init platform…');
    try {
      window.Lampa && window.Lampa.Platform && window.Lampa.Platform.tv && window.Lampa.Platform.tv();
      line('Lampa.Platform.tv() called');
    } catch(e){
      line('Platform.tv() not available yet');
    }

    status('fetch app.min.js…');

    // Можно заменить на https://yumata.github.io/lampa/app.min.js если он у тебя актуальный.
    const SRC = 'https://raw.githubusercontent.com/yumata/lampa/refs/heads/main/app.min.js';

    const res = await fetch(SRC, { cache: 'no-store' });
    if (!res.ok) throw new Error('Fetch failed: ' + res.status + ' ' + res.statusText);
    let js = await res.text();

    // --- PATCH: black_list ---
    let patched = false;
    js = js.replace(
      /black_list\.forEach\(function\s*\(b\)\s*\{/,
      (m) => { patched = true; return 'black_list.length=0;' + m; }
    );
    if (!patched) {
      const before = js;
      js = js
        .replace(/black_list\.push\('lipp\.xyz'\);\s*/g, '')
        .replace(/black_list\.push\('llpp\.xyz'\);\s*/g, '')
        .replace(/black_list\.push\('scabrum\.github\.io'\);\s*/g, '')
        .replace(/black_list\.push\('bylampa\.github\.io'\);\s*/g, '')
        .replace(/black_list\.push\('tinyurl\.com'\);\s*/g, '')
        .replace(/black_list\.push\('t\.me\/'\);\s*/g, '')
        .replace(/black_list\.push\('4pda\.'\);\s*/g, '')
        .replace(/black_list\.push\('teletype\.in'\);\s*/g, '')
        .replace(/black_list\.push\('yotube\.com'\);\s*/g, '');
      patched = (js !== before);
    }
    if (!patched) {
      status('PATCH FAILED');
      throw new Error('Patch failed (signature not found).');
    }

    // --- FIX: относительные пути к ресурсам ---
    // Без <base> часть путей вида "./vender/..." останется относительной к wrapper'у.
    // Поднимаем их в абсолютный yumata CDN.
    js = js
      .replace(/\.(\/vender\/)/g, 'https://yumata.github.io/lampa/vender/')
      .replace(/\.(\/plugins\/)/g, 'https://yumata.github.io/lampa/plugins/')
      .replace(/\.(\/img\/)/g, 'https://yumata.github.io/lampa/img/')
      .replace(/\.(\/css\/)/g, 'https://yumata.github.io/lampa/css/');

    status('run app…');

    const blob = new Blob([js], { type: 'application/javascript' });
    const url = URL.createObjectURL(blob);
    const s = document.createElement('script');
    s.src = url;
    s.onload = () => { try { URL.revokeObjectURL(url); } catch(e) {} };
    document.head.appendChild(s);

    // Если пульт/клавиши не ловятся — очень часто нужно, чтобы фокус был на body
    setTimeout(() => {
      try { window.focus(); } catch(e) {}
      try { document.body.focus && document.body.focus(); } catch(e) {}
    }, 1000);
  }

  boot().catch((e) => {
    status('BOOT FAILED');
    console.error(e);
  });
})();
</script>
</body>
</html>
